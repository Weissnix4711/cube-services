# CORS headers control (used for static and media files)
(cors-headers) {
	header Allow GET,HEAD,OPTIONS
	header Access-Control-Allow-Origin *
	header Access-Control-Allow-Methods GET,HEAD,OPTIONS
	header Access-Control-Allow-Headers Authorization,Content-Type,User-Agent

	@cors_preflight{args[0]} method OPTIONS

	handle @cors_preflight{args[0]} {
		respond "" 204
	}
}

# The default server address is configured in the .env file
# If not specified, the proxy listens for all http/https traffic
# If you need to listen on multiple addresses, or use a different port, you can modify this section directly
:80 {
	encode gzip

	request_body {
		max_size 100MB
	}

	# Handle static request files
	handle_path /static/* {
		import cors-headers static

		root * /var/www/static
		file_server
	}

	# Handle media request files
	handle_path /media/* {
		import cors-headers media

		root * /var/www/media
		file_server

		# Force download of media files (for security)
		# Comment out this line if you do not want to force download
		header Content-Disposition attachment

		# Authentication is handled by the forward_auth directive
		# This is required to ensure that media files are only accessible to authenticated users
		forward_auth "http://localhost:8000" {
			uri /auth/
		}
	}

	# All other requests are proxied to the InvenTree server
	reverse_proxy "http://localhost:8000" {
		trusted_proxies 10.99.0.0/28
	}
}
